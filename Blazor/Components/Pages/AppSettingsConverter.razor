@page "/AppSettingsConverter"
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<div class="container mt-4">
    <h3>AppSettings Converter</h3>
    <p class="text-muted">Konverter mellem appsettings.json og .env format</p>

    <div class="btn-group mb-4" role="group">
        <input type="radio" class="btn-check" name="conversionType" id="jsonToEnv" value="jsonToEnv" 
               @onclick="() => CurrentConversion = ConversionType.JsonToEnv" checked>
        <label class="btn btn-outline-primary" for="jsonToEnv">JSON → .env</label>

        <input type="radio" class="btn-check" name="conversionType" id="envToJson" value="envToJson" 
               @onclick="() => CurrentConversion = ConversionType.EnvToJson">
        <label class="btn btn-outline-primary" for="envToJson">.env → JSON</label>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="form-group">
                <label for="inputString">@(CurrentConversion == ConversionType.JsonToEnv ? "appsettings.json indhold" : ".env fil indhold")</label>
                <textarea class="form-control" id="inputString" @bind="InputString" rows="10"
                         placeholder="@(CurrentConversion == ConversionType.JsonToEnv ? 
                         "{\n  \"ConnectionStrings\": {\n    \"DefaultConnection\": \"Host=localhost;Database=test;\"\n  },\n  \"Logging\": {\n    \"LogLevel\": {\n      \"Default\": \"Information\"\n    }\n  }\n}" : 
                         "CONNECTIONSTRINGS__DEFAULTCONNECTION=Host=localhost;Database=test;\nLOGGING__LOGLEVEL__DEFAULT=Information")"></textarea>
            </div>
            
            <button class="btn btn-primary mt-3" @onclick="ConvertSettings">Konverter</button>
            
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger mt-3">
                    @ErrorMessage
                </div>
            }
            
            @if (!string.IsNullOrEmpty(Result))
            {
                <div class="mt-4">
                    <h4>Konverteret resultat:</h4>
                    <div class="form-group">
                        <div class="input-group">
                            <textarea class="form-control" readonly rows="10">@Result</textarea>
                            <button class="btn btn-outline-secondary" @onclick="CopyToClipboard">
                                <span class="bi bi-clipboard"></span> Kopiér
                            </button>
                        </div>
                    </div>
                    
                    @if (CurrentConversion == ConversionType.JsonToEnv)
                    {
                        <div class="mt-3">
                            <h5>Download .env fil:</h5>
                            <button class="btn btn-success" @onclick="DownloadEnvFile">
                                <span class="bi bi-download"></span> Download .env
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="mt-3">
                            <h5>Download appsettings.json:</h5>
                            <button class="btn btn-success" @onclick="DownloadJsonFile">
                                <span class="bi bi-download"></span> Download appsettings.json
                            </button>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    private enum ConversionType
    {
        JsonToEnv,
        EnvToJson
    }

    private ConversionType CurrentConversion { get; set; } = ConversionType.JsonToEnv;
    private string InputString { get; set; } = "";
    private string Result { get; set; } = "";
    private string ErrorMessage { get; set; } = "";

    private void ConvertSettings()
    {
        try
        {
            ErrorMessage = "";
            
            if (string.IsNullOrWhiteSpace(InputString))
            {
                ErrorMessage = "Indtast venligst indhold til konvertering";
                return;
            }

            if (CurrentConversion == ConversionType.JsonToEnv)
            {
                ConvertJsonToEnv();
            }
            else
            {
                ConvertEnvToJson();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Fejl under konvertering: {ex.Message}";
            Result = "";
        }
    }

    private void ConvertJsonToEnv()
    {
        try
        {
            // Parse JSON input
            var jsonDoc = System.Text.Json.JsonDocument.Parse(InputString);
            var envLines = new List<string>();
            
            ConvertJsonNodeToEnv(jsonDoc.RootElement, "", envLines);
            
            Result = string.Join("\n", envLines);
        }
        catch (Exception ex)
        {
            throw new Exception("Ugyldigt JSON format: " + ex.Message);
        }
    }

    private void ConvertJsonNodeToEnv(System.Text.Json.JsonElement element, string prefix, List<string> envLines)
    {
        foreach (var property in element.EnumerateObject())
        {
            var key = string.IsNullOrEmpty(prefix) ? property.Name : $"{prefix}__{property.Name}";
            
            if (property.Value.ValueKind == System.Text.Json.JsonValueKind.Object)
            {
                ConvertJsonNodeToEnv(property.Value, key, envLines);
            }
            else
            {
                var value = property.Value.ValueKind == System.Text.Json.JsonValueKind.String 
                    ? property.Value.GetString() 
                    : property.Value.ToString();
                envLines.Add($"{key.ToUpper()}={value}");
            }
        }
    }

    private void ConvertEnvToJson()
    {
        try
        {
            var envLines = InputString.Split('\n', StringSplitOptions.RemoveEmptyEntries);
            var jsonDict = new Dictionary<string, object>();
            
            foreach (var line in envLines)
            {
                var trimmedLine = line.Trim();
                if (string.IsNullOrEmpty(trimmedLine) || trimmedLine.StartsWith("#"))
                    continue;
                
                var equalIndex = trimmedLine.IndexOf('=');
                if (equalIndex == -1)
                    continue;
                
                var key = trimmedLine.Substring(0, equalIndex).ToLower();
                var value = trimmedLine.Substring(equalIndex + 1);
                
                // Parse nested keys (e.g., "connectionstrings__defaultconnection")
                var keyParts = key.Split("__");
                BuildNestedDictionary(jsonDict, keyParts, value);
            }
            
            // Convert to formatted JSON
            var options = new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true
            };
            
            Result = System.Text.Json.JsonSerializer.Serialize(jsonDict, options);
        }
        catch (Exception ex)
        {
            throw new Exception("Ugyldigt .env format: " + ex.Message);
        }
    }

    private void BuildNestedDictionary(Dictionary<string, object> dict, string[] keyParts, string value)
    {
        var current = dict;
        
        for (int i = 0; i < keyParts.Length - 1; i++)
        {
            var key = keyParts[i];
            if (!current.ContainsKey(key))
            {
                current[key] = new Dictionary<string, object>();
            }
            current = (Dictionary<string, object>)current[key];
        }
        
        current[keyParts[keyParts.Length - 1]] = value;
    }

    private async Task CopyToClipboard()
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", Result);
    }

    private async Task DownloadEnvFile()
    {
        var fileName = "appsettings.env";
        var mimeType = "text/plain";
        await DownloadFile(Result, fileName, mimeType);
    }

    private async Task DownloadJsonFile()
    {
        var fileName = "appsettings.json";
        var mimeType = "application/json";
        await DownloadFile(Result, fileName, mimeType);
    }

    private async Task DownloadFile(string content, string fileName, string mimeType)
    {
        var bytes = System.Text.Encoding.UTF8.GetBytes(content);
        var base64 = Convert.ToBase64String(bytes);
        var dataUrl = $"data:{mimeType};base64,{base64}";
        
        await JSRuntime.InvokeVoidAsync("downloadFile", dataUrl, fileName);
    }
}
