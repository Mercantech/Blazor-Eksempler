@page "/chatroom"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager

<div class="chat-container">
    <div class="chat-header">
        <h4>Velkommen, @currentUser!</h4>
    </div>
    <div class="chat-content">
        <div class="chat-messages">
            <ul>
                @foreach (var message in messages)
                {
                    <li class="@(message.StartsWith(currentUser) ? "sent" : "received")">
                        <div class="message">@message</div>
                    </li>
                }
                @if (!string.IsNullOrEmpty(typingUser))
                {
                    <li class="typing received">
                        <div class="message">@typingUser skriver...</div>
                    </li>
                }
            </ul>
        </div>
    </div>
    <div class="chat-input">
        <input @bind="messageInput" @bind:event="oninput" @onkeyup="HandleInput" placeholder="Skriv en besked..." />
        <button @onclick="Send">Send</button>
    </div>
</div>

@code {
    private HubConnection hubConnection;
    private List<string> messages = new List<string>();
    private string messageInput;
    private string currentUser;
    private string typingUser;
    private System.Timers.Timer typingTimer;
    private List<string> activeUsers = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/chathub"))
            .Build();

        hubConnection.On<string, string>("ReceiveMessage", async (user, message) =>
        {
            var encodedMsg = $"{user}: {message}";
            messages.Add(encodedMsg);
            await InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string>("UserTyping", async (user) =>
        {
            typingUser = user;
            await InvokeAsync(StateHasChanged);

            // Reset the typing timer
            typingTimer?.Dispose();
            typingTimer = new System.Timers.Timer(1000);
            typingTimer.Elapsed += async (sender, e) =>
            {
                typingUser = null;
                await InvokeAsync(StateHasChanged);
            };
            typingTimer.AutoReset = false;
            typingTimer.Start();
        });

        hubConnection.On<string>("UserConnected", async (user) =>
        {
            activeUsers.Add(user);
            await InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string>("UserDisconnected", async (user) =>
        {
            activeUsers.Remove(user);
            await InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();

        currentUser = await hubConnection.InvokeAsync<string>("GetUniqueUserName");
    }

    private async Task Send()
    {
        await hubConnection.SendAsync("SendMessage", currentUser, messageInput);
        messageInput = "";
    }

    private async Task HandleInput()
    {
        await hubConnection.SendAsync("Typing", currentUser);
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
        typingTimer?.Dispose();
    }
}

<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 60px);
    }

    .chat-header {
        background-color: #f1f1f1;
        padding: 20px;
        text-align: center;
    }

    .chat-content {
        display: flex;
        flex-grow: 1;
    }

    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .chat-messages ul {
        list-style-type: none;
        padding: 0;
    }

    .chat-messages li {
        margin-bottom: 10px;
        display: flex;
    }

    .sent {
        justify-content: flex-end;
    }

    .received {
        justify-content: flex-start;
    }

    .message {
        padding: 10px;
        border-radius: 10px;
        max-width: 80%;
    }

    .sent .message {
        background-color: #007bff;
        color: white;
    }

    .received .message {
        background-color: #f1f1f1;
        color: black;
    }

    .typing .message {
        font-style: italic;
    }

    .chat-input {
        display: flex;
        padding: 20px;
        background-color: #f1f1f1;
    }

    .chat-input input {
        flex-grow: 1;
        padding: 10px;
        border: none;
        border-radius: 5px;
        margin-right: 10px;
    }

    .chat-input button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .chat-users {
        width: 200px;
        background-color: #f1f1f1;
        padding: 20px;
    }

    .chat-users ul {
        list-style-type: none;
        padding: 0;
    }
</style>